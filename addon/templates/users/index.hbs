<DataTable
  @modelName="user"
  @page={{this.page}}
  @search={{this.search}}
  @defaultSort="last_name"
  @updatePage={{fn this.updateQueryParam "page"}}
  @updateSearch={{fn this.updateQueryParam "search"}}
  @updateSort={{fn this.updateQueryParam "sort"}}
  @include={{array "acls.role" "acls.scope"}}
  as |table|
>
  <table.head as |head|>
    {{#unless this.emailAsUsername}}
      <head.sortable @sort="username">
        {{t "emeis.users.headings.username"}}
      </head.sortable>
      {{/unless}}
    <head.sortable @sort="last_name">
      {{t "emeis.users.headings.lastName"}}
    </head.sortable>
    <head.sortable @sort="first_name">
      {{t "emeis.users.headings.firstName"}}
    </head.sortable>
    <head.sortable @sort="email">
      {{t "emeis.users.headings.email"}}
    </head.sortable>
    {{#with head.includes as |includes|}}
      {{#if includes.roles}}
        <head.nonsortable>
          {{t "emeis.roles.title"}}
        </head.nonsortable>
      {{/if}}
      {{#if includes.scopes}}
        <head.nonsortable>
          {{t "emeis.scopes.title"}}
        </head.nonsortable>
      {{/if}}
    {{/with}}
  </table.head>
  <table.body as |body|>
    <body.row>
      {{#let body.model as |user|}}
        {{#if this.emailAsUsername}}
          <td>
            <LinkTo @route="users.edit" @model={{user}} class="uk-link-text">
              {{user.lastName}}
            </LinkTo>
          </td>
          <td>{{user.firstName}}</td>
        {{else}}
          <td data-test-user-username={{user.id}}>
            <LinkTo @route="users.edit" @model={{user}} class="uk-link-text">
              {{user.username}}
            </LinkTo>
          </td>
          <td>{{user.lastName}}</td>
          <td>{{user.firstName}}</td>
        {{/if}}

        <td data-test-user-email={{user.id}}>
          {{user.email}}
        </td>
        {{#with body.includes as |includes|}}
          {{#let user.acls as |acls|}}
            {{!-- ROLES --}}
            {{#with includes.roles as |roles|}}
              <td>
                <ul class="uk-list uk-list-divider">
                  {{#each acls as |acl|}}
                    <li>
                      {{#if roles.link}}
                        <LinkTo @route="roles.edit" @model={{acl.role}} class="uk-link-text">
                          {{acl.role.id}}
                        </LinkTo>
                      {{else}}
                        {{acl.role.id}}
                      {{/if}}
                    </li>
                  {{else}}
                  -
                  {{/each}}
                </ul>
              </td>
            {{/with}}
            {{!-- SCOPES --}}
            {{#with includes.scopes as |scopes|}}
              <td>
                <ul class="uk-list uk-list-divider">
                  {{#each acls as |acl|}}
                    <li>
                      {{#if scopes.link}}
                        <LinkTo @route="scopes.edit" @model={{acl.scope}} class="uk-link-text">
                          {{acl.scope.name}}
                        </LinkTo>
                      {{else}}
                          {{acl.scope.name}}
                      {{/if}}
                    </li>
                  {{else}}
                  -
                  {{/each}}
                </ul>
              </td>
            {{/with}}
          {{/let}}
        {{/with}}
      {{/let}}
    </body.row>
  </table.body>
</DataTable>
